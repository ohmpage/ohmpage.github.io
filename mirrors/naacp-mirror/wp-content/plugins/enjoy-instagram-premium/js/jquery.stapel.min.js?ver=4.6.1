(function(c,l,w){var v=c.event,p,q;p=v.special.debouncedresize={setup:function(){c(this).on("resize",p.handler)},teardown:function(){c(this).off("resize",p.handler)},handler:function(b,a){var c=this,f=arguments,e=function(){b.type="debouncedresize";v.dispatch.apply(c,f)};q&&clearTimeout(q);a?e():q=setTimeout(e,p.threshold)},threshold:150};c.fn.imagesLoaded=function(b){function a(){var a=c(m),d=c(n);e&&(n.length?e.reject(k,a,d):e.resolve(k));c.isFunction(b)&&b.call(f,k,a,d)}function d(b,d){"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw=="!==
b.src&&-1===c.inArray(b,g)&&(g.push(b),d?n.push(b):m.push(b),c.data(b,"imagesLoaded",{isBroken:d,src:b.src}),h&&e.notifyWith(c(b),[d,k,c(m),c(n)]),k.length===g.length&&(setTimeout(a),k.unbind(".imagesLoaded")))}var f=this,e=c.isFunction(c.Deferred)?c.Deferred():0,h=c.isFunction(e.notify),k=f.find("img").add(f.filter("img")),g=[],m=[],n=[];c.isPlainObject(b)&&c.each(b,function(a,c){if("callback"===a)b=c;else if(e)e[a](c)});k.length?k.bind("load.imagesLoaded error.imagesLoaded",function(b){d(b.target,
"error"===b.type)}).each(function(b,a){var e=a.src,f=c.data(a,"imagesLoaded");if(f&&f.src===e)d(a,f.isBroken);else if(a.complete&&a.naturalWidth!==w)d(a,0===a.naturalWidth||0===a.naturalHeight);else if(a.readyState||a.complete)a.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==",a.src=e}):a();return e?e.promise(f):f};var x=c(l),u=l.Modernizr;c.Stapel=function(b,a){this.el=c(a);this._init(b)};c.Stapel.defaults={gutter:40,pileAngles:2,pileAnimation:{openSpeed:400,openEasing:"ease-in-out",
closeSpeed:400,closeEasing:"ease-in-out"},otherPileAnimation:{openSpeed:400,openEasing:"ease-in-out",closeSpeed:350,closeEasing:"ease-in-out"},delay:0,randomAngle:!1,onLoad:function(){return!1},onBeforeOpen:function(b){return!1},onAfterOpen:function(b,a){return!1},onBeforeClose:function(b){return!1},onAfterClose:function(b,a){return!1}};c.Stapel.prototype={_init:function(b){this.options=c.extend(!0,{},c.Stapel.defaults,b);this._config();var a=this;this.el.imagesLoaded(function(){a.options.onLoad();
a._layout();a._initEvents()})},_config:function(){this.support=u.csstransitions;var b={WebkitTransition:"webkitTransitionEnd",MozTransition:"transitionend",OTransition:"oTransitionEnd",msTransition:"MSTransitionEnd",transition:"transitionend"},a={WebkitTransform:"-webkit-transform",MozTransform:"-moz-transform",OTransform:"-o-transform",msTransform:"-ms-transform",transform:"transform"};this.support&&(this.transEndEventName=b[u.prefixed("transition")]+".cbpFWSlider",this.transformName=a[u.prefixed("transform")]);
this.spread=!1;this.items=this.el.children("li").hide();this.close=c("#tp-close")},_getSize:function(){this.elWidth=this.el.outerWidth(!0)},_initEvents:function(){var b=this;x.on("debouncedresize.stapel",function(){b._resize()});this.items.on("click.stapel",function(){var a=c(this);if(!b.spread&&a.data("isPile"))return b.spread=!0,b.pileName=a.data("pileName"),b.options.onBeforeOpen(b.pileName),b._openPile(),!1})},_layout:function(){this._piles();this.itemSize={width:this.items.outerWidth(!0),height:this.items.outerHeight(!0)};
this.items.remove();this._setInitialStyle();this.el.css("min-width",this.itemSize.width+this.options.gutter);this._getSize();this._setItemsPosition();this.items=this.el.children("li").show();this.itemsCount=this.items.length},_piles:function(){this.piles={};var b,a=this,d=0;this.items.each(function(){for(var f=c(this),e=(f.attr("data-pile")||"nopile-"+f.index()).split(","),h=0,k=e.length;h<k;++h){var g=c.trim(e[h]);b=a.piles[g];b||(b=a.piles[g]={elements:[],position:{left:0,top:0},index:d},++d);g=
f.clone().get(0);b.elements.push({el:g,finalPosition:{left:0,top:0}});c(g).appendTo(a.el)}})},_setInitialStyle:function(){for(var b in this.piles)for(var a=this.piles[b],d=0,f=a.elements.length;d<f;++d){var e=c(a.elements[d].el),h={transform:"rotate(0deg)"};this._applyInitialTransition(e);if(d===f-2)h={transform:"rotate("+this.options.pileAngles+"deg)"};else if(d===f-3)h={transform:"rotate(-"+this.options.pileAngles+"deg)"};else if(d!==f-1){var k={visibility:"hidden"};e.css(k).data("extraStyle",k)}else"nopile"!==
b.substr(0,6)&&e.data("front",!0).append('<div class="tp-title"><span>'+b+"</span><span>"+f+"</span></div>");e.css(h).data({initialStyle:h,pileName:b,pileCount:f,shadow:e.css("box-shadow"),isPile:"nopile"===b.substr(0,6)?!1:!0})}},_applyInitialTransition:function(b){this.support&&b.css("transition","left 400ms ease-in-out, top 400ms ease-in-out")},_setItemsPosition:function(){var b=0,a=0,d,f,e=0,h=0,k;for(k in this.piles){var g=this.piles[k],m=this.itemSize.width+this.options.gutter,n=0,t=0,r,l;b+
m<=this.elWidth?(d=b,f=a,b+=m):(0===e&&(e=Math.ceil((this.elWidth-b+this.options.gutter)/2)),a+=this.itemSize.height+this.options.gutter,d=0,f=a,b=m);g.position.left=d;g.position.top=f;d=0;for(f=g.elements.length;d<f;++d){var p=g.elements[d],q=p.finalPosition;n+m<=this.elWidth?(r=n,l=t,n+=m):(t+=this.itemSize.height+this.options.gutter,r=0,l=t,n=m);q.left=r;q.top=l;r=c(p.el);k!==this.pileName?r.css({left:g.position.left,top:g.position.top}):(h=p.finalPosition.top,r.css({left:p.finalPosition.left,
top:h}))}}h=this.spread?h:a;this.el.css({marginLeft:e,height:h+this.itemSize.height})},_openPile:function(){if(!this.spread)return!1;var b,a;for(a in this.piles)for(var d=this.piles[a],f=0,e=0,h=d.elements.length;e<h;++e){var k=d.elements[e],g=c(k.el),m=g.find("img"),n=a===this.pileName?{zIndex:9999,visibility:"visible",transition:this.support?"left "+this.options.pileAnimation.openSpeed+"ms "+(h-e-1)*this.options.delay+"ms "+this.options.pileAnimation.openEasing+", top "+this.options.pileAnimation.openSpeed+
"ms "+(h-e-1)*this.options.delay+"ms "+this.options.pileAnimation.openEasing+", "+this.transformName+" "+this.options.pileAnimation.openSpeed+"ms "+(h-e-1)*this.options.delay+"ms "+this.options.pileAnimation.openEasing:"none"}:{zIndex:1,transition:this.support?"opacity "+this.options.otherPileAnimation.closeSpeed+"ms "+this.options.otherPileAnimation.closeEasing:"none"};a===this.pileName?(g.data("front")&&g.find("div.tp-title").hide(),e<h-1&&m.css("visibility","visible"),b=k.finalPosition,b.transform=
this.options.randomAngle&&e!==d.index?"rotate("+Math.floor(11*Math.random()-5)+"deg)":"none",this.support||g.css("transform","none"),e<h-3&&g.css("box-shadow","none")):e<h-1&&m.css("visibility","hidden");g.css(n);var l=this;a===this.pileName?this._applyTransition(g,b,this.options.pileAnimation.openSpeed,function(b){"LI"===(this.target||this.nodeName)&&(b=c(this),b.css("box-shadow",b.data("shadow")),l.support&&b.off(l.transEndEventName),++f,f===b.data("pileCount")&&(c(document).one("mousemove.stapel",
function(){l.el.addClass("tp-open")}),l.options.onAfterOpen(l.pileName,f)))}):this._applyTransition(g,{opacity:0},this.options.otherPileAnimation.closeSpeed)}this.el.css("height",b.top+this.itemSize.height)},_closePile:function(){var b=this;if(this.spread){this.spread=!1;this.options.onBeforeClose(this.pileName);this.el.removeClass("tp-open");var a,d;for(d in this.piles)for(var f=this.piles[d],e=0,h=0,k=f.elements.length;h<k;++h){var g=c(f.elements[h].el);g.css(d===this.pileName?{transition:this.support?
"left "+this.options.pileAnimation.closeSpeed+"ms "+this.options.pileAnimation.closeEasing+", top "+this.options.pileAnimation.closeSpeed+"ms "+this.options.pileAnimation.closeEasing+", "+this.transformName+" "+this.options.pileAnimation.closeSpeed+"ms "+this.options.pileAnimation.closeEasing:"none"}:{transition:this.support?"opacity "+this.options.otherPileAnimation.openSpeed+"ms "+this.options.otherPileAnimation.openEasing:"none"});a=f.position;d===this.pileName&&(c.extend(a,g.data("initialStyle")),
h<k-3&&g.css("box-shadow","none"));d===this.pileName?this._applyTransition(g,a,this.options.pileAnimation.closeSpeed,function(a){if("LI"===(this.target||this.nodeName)){a=c(this);var d=a.data("extraStyle");a.css("box-shadow",a.data("shadow"));b.support?(a.off(b.transEndEventName),b._applyInitialTransition(a)):a.css(a.data("initialStyle"));d&&a.css(d);++e;a.data("front")&&a.find("div.tp-title").show();if(e===a.data("pileCount"))b.options.onAfterClose(a.data("pileName"),e)}}):this._applyTransition(g,
{opacity:1},this.options.otherPileAnimation.openSpeed,function(a){"LI"===(this.target||this.nodeName)&&(a=c(this),a.index()<k-1&&a.find("img").css("visibility","visible"),b.support&&(a.off(b.transEndEventName),b._applyInitialTransition(a)))})}this.pileName="";this.el.css("height",a.top+this.itemSize.height)}return!1},_resize:function(){this._getSize();this._setItemsPosition()},_applyTransition:function(b,a,d,f){c.fn.applyStyle=this.support?c.fn.css:c.fn.animate;if(f&&this.support)b.on(this.transEndEventName,
f);f=f||function(){return!1};b.stop().applyStyle(a,c.extend(!0,[],{duration:d+"ms",complete:f}))},closePile:function(){this._closePile()}};c.fn.stapel=function(b){var a=c.data(this,"stapel");if("string"===typeof b){var d=Array.prototype.slice.call(arguments,1);this.each(function(){a?c.isFunction(a[b])&&"_"!==b.charAt(0)?a[b].apply(a,d):l.console&&l.console.error("no such method '"+b+"' for stapel instance"):l.console&&l.console.error("cannot call methods on stapel prior to initialization; attempted to call method '"+
b+"'")})}else this.each(function(){a?a._init():a=c.data(this,"stapel",new c.Stapel(b,this))});return a}})(jQuery,window);
