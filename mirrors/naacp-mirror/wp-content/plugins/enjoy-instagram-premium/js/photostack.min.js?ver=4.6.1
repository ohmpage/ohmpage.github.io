(function(h){function l(a,b){for(var e in b)b.hasOwnProperty(e)&&(a[e]=b[e]);return a}function z(a){for(var b=[],e=a.length,A=a[0].length,f=0;f<e;f++)b=b.concat(a[f]);a=b.length;for(var c;a;)c=Math.floor(Math.random()*a--),f=b[a],b[a]=b[c],b[c]=f;a=[];for(c=f=0;c<e;c++){for(var d=[],m=0;m<A;m++)d.push(b[f]),f++;a.push(d)}return a}function c(a,b){this.el=a;this.inner=this.el.querySelector("div");this.allItems=[].slice.call(this.inner.children);if(this.allItemsCount=this.allItems.length){this.items=
[].slice.call(this.inner.querySelectorAll("figure:not([data-dummy])"));this.itemsCount=this.items.length;this.options=l({},this.options);l(this.options,b);this.current=this.options.start;this._init();var e=this;return{showPhoto:function(a){e._showPhoto.call(e,a)},open:function(){e._open.call(e,!0)},navigate:function(a){e._navigate.call(e,a)}}}}Modernizr.addTest("csstransformspreserve3d",function(){var a=Modernizr.prefixed("transformStyle"),b;if(!a)return!1;a=a.replace(/([A-Z])/g,function(a,b){return"-"+
b.toLowerCase()}).replace(/^ms-/,"-ms-");Modernizr.testStyles("#modernizr{"+a+":preserve-3d;}",function(e,c){b=h.getComputedStyle?getComputedStyle(e,null).getPropertyValue(a):""});return"preserve-3d"===b});var n=Modernizr.csstransitions,g=Modernizr.csstransformspreserve3d,p={WebkitTransition:"webkitTransitionEnd",MozTransition:"transitionend",OTransition:"oTransitionEnd",msTransition:"MSTransitionEnd",transition:"transitionend"}[Modernizr.prefixed("transition")];c.prototype.options={start:0,showNavigation:!0,
afterInit:null,afterShowPhoto:null,afterNavigate:null};c.prototype._init=function(){this.currentItem=this.items[this.current];this.options.showNavigation&&this._addNavigation();this._getSizes();this._initEvents();this.options.afterInit&&this.options.afterInit(this)};c.prototype._addNavigation=function(){this.nav=document.createElement("nav");for(var a="",b=0;b<this.itemsCount;++b)a+="<span></span>";this.nav.innerHTML=a;this.el.appendChild(this.nav);this.navDots=[].slice.call(this.nav.children)};c.prototype._open=
function(a){var b=this.el,e=function(){n&&classie.addClass(b,"photostack-transition")};a?(b.removeEventListener("click",open),classie.removeClass(b,"photostack-start"),e()):(this.openDefault=!0,setTimeout(e,25));this.started=!0;this._showPhoto(this.current)};c.prototype._initEvents=function(){var a=this,b=classie.hasClass(this.el,"photostack-start");b?(this._shuffle(),this.el.addEventListener("click",function(){a._open(b)})):this._open(b);this.options.showNavigation&&this.navDots.forEach(function(b,
c){b.addEventListener("click",function(){if(c===a.current)a._rotateItem();else{var b=function(){a._showPhoto(c)};a.flipped?a._rotateItem(b):b()}})});h.addEventListener("resize",function(){a._resizeHandler()})};c.prototype._resizeHandler=function(){var a=this;this._resizeTimeout&&clearTimeout(this._resizeTimeout);this._resizeTimeout=setTimeout(function(){a._resize();a._resizeTimeout=null},100)};c.prototype._resize=function(){var a=this,b=function(){a._shuffle(!0)};this._getSizes();this.started&&this.flipped?
this._rotateItem(b):b()};c.prototype._showPhoto=function(a){if(this.isShuffling)return!1;this.isShuffling=!0;classie.hasClass(this.currentItem,"photostack-flip")&&(this._removeItemPerspective(),this.options.showNavigation&&classie.removeClass(this.navDots[this.current],"flippable"));this.options.showNavigation&&classie.removeClass(this.navDots[this.current],"current");classie.removeClass(this.currentItem,"photostack-current");this.current=a;this.currentItem=this.items[this.current];this.options.showNavigation&&
classie.addClass(this.navDots[this.current],"current");this.options.showNavigation&&this.currentItem.querySelector(".photostack-back")&&classie.addClass(this.navDots[a],"flippable");this._shuffle();this.options.afterShowPhoto&&this.options.afterShowPhoto(this)};c.prototype._shuffle=function(a){var b=a?1:this.currentItem.getAttribute("data-shuffle-iteration")||1;if(0>=b||!this.started||this.openDefault)b=1;this.openDefault&&(classie.addClass(this.currentItem,"photostack-flip"),this.isShuffling=this.openDefault=
!1);var e=Math.ceil(this.sizes.inner.width/(.5*this.sizes.item.width)),c=Math.ceil(this.sizes.inner.height/(.5*this.sizes.item.height)),f=(e*this.sizes.item.width*.5+this.sizes.item.width/2-this.sizes.inner.width)/2,x=(c*this.sizes.item.height*.5+this.sizes.item.height/2-this.sizes.inner.height)/2,d=this,m=function(){--b;for(var a=[],k=0;k<c;++k)for(var g=a[k]=[],q=0;q<e;++q){var h=.5*q*d.sizes.item.width-f,l=.5*k*d.sizes.item.height-x,u=0,v=0;if(d.started&&0===b){var w=d._isOverlapping({x:h,y:l});
if(w.overlapping)switch(u=w.noOverlap.x,v=w.noOverlap.y,Math.floor(3*Math.random())){case 0:u=0;break;case 1:v=0}}g[q]={x:h+u,y:l+v}}var a=z(a),r=0,t=0,y=0;d.allItems.forEach(function(f,x){r===e-1?(t=t===c-1?0:t+1,r=1):++r;var k=a[t][r-1],h=k.x,k=k.y,g=function(){++y;n&&this.removeEventListener(p,g);y===d.allItemsCount&&(0<b?m.call():(classie.addClass(d.currentItem,"photostack-flip"),d.isShuffling=!1,"function"===typeof d.options.callback&&d.options.callback(d.currentItem)))};d.items.indexOf(f)===
d.current&&d.started&&0===b?(d.currentItem.style.WebkitTransform="translate("+d.centerItem.x+"px,"+d.centerItem.y+"px) rotate(0deg)",d.currentItem.style.msTransform="translate("+d.centerItem.x+"px,"+d.centerItem.y+"px) rotate(0deg)",d.currentItem.style.transform="translate("+d.centerItem.x+"px,"+d.centerItem.y+"px) rotate(0deg)",d.currentItem.querySelector(".photostack-back")&&d._addItemPerspective(),classie.addClass(d.currentItem,"photostack-current")):(f.style.WebkitTransform="translate("+h+"px,"+
k+"px) rotate("+Math.floor(71*Math.random()+-35)+"deg)",f.style.msTransform="translate("+h+"px,"+k+"px) rotate("+Math.floor(71*Math.random()+-35)+"deg)",f.style.transform="translate("+h+"px,"+k+"px) rotate("+Math.floor(71*Math.random()+-35)+"deg)");d.started&&(n?f.addEventListener(p,g):g())})};m.call()};c.prototype._navigate=function(a){var b=this.current,e=this.itemsCount-1,c=0;"next"==a?c=b<e?b+1:0:"prev"==a&&(c=0<b?b-1:e);this._showPhoto(c);this.options.afterNavigate&&this.options.afterNavigate(this)};
c.prototype._getSizes=function(){this.sizes={inner:{width:this.inner.offsetWidth,height:this.inner.offsetHeight},item:{width:this.currentItem.offsetWidth,height:this.currentItem.offsetHeight}};this.centerItem={x:this.sizes.inner.width/2-this.sizes.item.width/2,y:this.sizes.inner.height/2-this.sizes.item.height/2}};c.prototype._isOverlapping=function(a){var b=this.sizes.item.width+this.sizes.item.width/3,c=this.sizes.item.height+this.sizes.item.height/3,h=this.sizes.inner.width/2-b/2,f=this.sizes.inner.height/
2-c/2,g=this.sizes.item.width,d=this.sizes.item.height;if(!(a.x+g<h||a.x>h+b||a.y+d<f||a.y>f+c)){var m=.5>Math.random(),l=Math.floor(Math.random()*(g/4+1)),k=Math.floor(Math.random()*(d/4+1));return{overlapping:!0,noOverlap:{x:m?-1*(a.x-h+g)-l:h+b-(a.x+g)+g+l,y:m?-1*(a.y-f+d)-k:f+c-(a.y+d)+d+k}}}return{overlapping:!1}};c.prototype._addItemPerspective=function(){classie.addClass(this.el,"photostack-perspective")};c.prototype._removeItemPerspective=function(){classie.removeClass(this.el,"photostack-perspective");
classie.removeClass(this.currentItem,"photostack-flip")};c.prototype._rotateItem=function(a){if(classie.hasClass(this.el,"photostack-perspective")&&!this.isRotating&&!this.isShuffling){this.isRotating=!0;var b=this,c=function(){n&&g&&this.removeEventListener(p,c);b.isRotating=!1;"function"===typeof a&&a()};this.flipped?(this.options.showNavigation&&classie.removeClass(this.navDots[this.current],"flip"),g?(this.currentItem.style.WebkitTransform="translate("+this.centerItem.x+"px,"+this.centerItem.y+
"px) rotateY(0deg)",this.currentItem.style.transform="translate("+this.centerItem.x+"px,"+this.centerItem.y+"px) rotateY(0deg)"):classie.removeClass(this.currentItem,"photostack-showback")):(this.options.showNavigation&&classie.addClass(this.navDots[this.current],"flip"),g?(this.currentItem.style.WebkitTransform="translate("+this.centerItem.x+"px,"+this.centerItem.y+"px) translate("+this.sizes.item.width+"px) rotateY(-179.9deg)",this.currentItem.style.transform="translate("+this.centerItem.x+"px,"+
this.centerItem.y+"px) translate("+this.sizes.item.width+"px) rotateY(-179.9deg)"):classie.addClass(this.currentItem,"photostack-showback"));this.flipped=!this.flipped;n&&g?this.currentItem.addEventListener(p,c):c()}};h.Photostack=c})(window);
